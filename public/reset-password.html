<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>reset password - siduri</title>
  <link rel="stylesheet" href="css/siduri.css">
  <style>
    body { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: var(--bg-primary); }
    .auth-card { width: 100%; max-width: 400px; padding: 2rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; text-align: center; }
    .auth-icon { width: 60px; height: 60px; margin: 0 auto 1.5rem; }
    .auth-icon img { width: 100%; height: 100%; object-fit: contain; }
    h1 { font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-primary); }
    .auth-subtitle { color: var(--text-secondary); margin-bottom: 2rem; font-size: 0.9rem; }
    .form-group { margin-bottom: 1rem; text-align: left; }
    label { display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem; }
    input[type="password"] { width: 100%; padding: 0.75rem 1rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: 'Space Grotesk', sans-serif; font-size: 1rem; box-sizing: border-box; }
    input:focus { outline: none; border-color: var(--text-primary); }
    .btn { width: 100%; padding: 0.75rem; border-radius: 999px; font-size: 1rem; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--text-primary); color: var(--bg-primary); border: none; }
    .btn-primary:hover:not(:disabled) { background: var(--text-secondary); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .message { font-size: 0.875rem; margin-top: 0.5rem; padding: 0.75rem; border-radius: 8px; display: none; }
    .message.show { display: block; }
    .message.error { color: var(--error); background: rgba(255, 0, 0, 0.1); }
    .message.success { color: #4ade80; background: rgba(74, 222, 128, 0.1); }
    .auth-toggle { margin-top: 1.5rem; color: var(--text-secondary); font-size: 0.875rem; }
    .auth-toggle a { color: var(--text-primary); text-decoration: none; }
    .auth-toggle a:hover { text-decoration: underline; }
    .invalid-token { display: none; }
    .invalid-token.show { display: block; }
    .reset-form.hide { display: none; }
  </style>
</head>
<body>
  <div class="auth-card">
    <div class="auth-icon"><img src="img/icon_01.svg" alt="siduri"></div>
    <div class="invalid-token" id="invalidToken">
      <h1>invalid link</h1>
      <p class="auth-subtitle">this reset link is invalid or has expired</p>
      <a href="forgot-password.html" class="btn btn-primary" style="display: inline-block; text-decoration: none;">request new link</a>
    </div>
    <div class="reset-form" id="resetForm">
      <h1>reset password</h1>
      <p class="auth-subtitle">enter your new password</p>
      <form id="resetFormElement">
        <div class="form-group">
          <label for="password">new password (min 12 characters)</label>
          <input type="password" id="password" autocomplete="new-password" required minlength="12">
        </div>
        <div class="form-group">
          <label for="confirmPassword">confirm password</label>
          <input type="password" id="confirmPassword" autocomplete="new-password" required minlength="12">
        </div>
        <div class="message" id="message"></div>
        <button type="submit" class="btn btn-primary" id="submitBtn">reset password</button>
      </form>
      <div class="auth-toggle"><a href="./">back to login</a></div>
    </div>
  </div>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const invalidToken = document.getElementById('invalidToken');
    const resetForm = document.getElementById('resetForm');
    const form = document.getElementById('resetFormElement');
    const message = document.getElementById('message');
    const submitBtn = document.getElementById('submitBtn');
    if (!token) { invalidToken.classList.add('show'); resetForm.classList.add('hide'); }
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      if (password !== confirmPassword) { message.textContent = 'passwords do not match'; message.classList.add('show', 'error'); return; }
      if (password.length < 12) { message.textContent = 'password must be at least 12 characters'; message.classList.add('show', 'error'); return; }
      submitBtn.disabled = true; submitBtn.textContent = 'resetting...';
      message.classList.remove('show', 'error', 'success');
      try {
        const res = await fetch('/api/auth/reset-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token, password }) });
        const data = await res.json();
        if (res.ok) {
          message.textContent = 'password reset successfully! redirecting to login...';
          message.classList.add('show', 'success');
          setTimeout(() => { window.location.href = './'; }, 2000);
        } else {
          if (data.error === 'Invalid or expired reset token') { invalidToken.classList.add('show'); resetForm.classList.add('hide'); }
          else { message.textContent = data.error || 'something went wrong'; message.classList.add('show', 'error'); }
        }
      } catch (err) { message.textContent = 'network error. please try again.'; message.classList.add('show', 'error'); }
      finally { submitBtn.disabled = false; submitBtn.textContent = 'reset password'; }
    });
  </script>
</body>
</html>
